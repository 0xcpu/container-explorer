# Container-Explorer

Container-Explorer is a tool to explore containers on a mount image. Container-Explorer supports exploring containers managed using containerd and docker.
Container-Explorer attempts to provide the familiar output generated by `ctr` and `docker` command line tools.

Container-Explorer provides the following options:

- Explore namespaces
- Explore containers
- Explore snapshots
- Explore images
- Explore contents
- Mount container

## Usage

### Using Virtual Machine Image

Container-Explorer can explore an offline `containerd` by using a commandline switch `--image-root` that
refers the location of mounted image containing `containerd`. The section below shows the container-explorer
commands:

1; Mount the image containing containerd

```bash
sudo mount -o ro /mnt/tags/tag001 /mnt/cases/case001
```

2; Run `container-explorer` commands to explore containers

**Containerd managed containers**

Listing namespaces

```bash
sudo container-explorer --image-root /mnt/cases/case001 list namespaces
NAMESPACE
k8s.io
moby
```

Listing containers and hiding labels for readability

```bash
sudo container-explorer --image-root /mnt/cases/case001 list containers --no-labels
NAMESPACE       CONTAINER ID                                                            CONTAINER HOSTNAME                      IMAGE                                                                   CREATED AT
k8s.io          10c91402505488c2f9172143ca944b93cdf3292e6e355e54f26f5e43d0ed66ec        konnectivity-agent-6766754664-2tmn9     sha256:1434d0253770fd89f2d37698cc1cb698bcd539ad3603499f6772ac946a83f16d 2021-11-22T20:04:42Z
k8s.io          214e8a9f65b0d90533f4c6a893f1e71b56f55ac68a00982f57465ae1679ee678        metrics-server-v0.4.4-857776bc9c-wqc89  sha256:063c412851871326256396939647aab4b1cb4209662ef9880b8edaaff60b5d05 2021-11-22T20:05:00Z
k8s.io          3af7bcecba1da661b02b87d26de7c4b6d7d351b778d001197743053a18dda93c        nginx-1-754ddbcd6c-d847j                docker.io/library/nginx:latest                                          2021-11-22T20:05:50Z
```

Listing snapshots

```bash
sudo container-explorer --image-root /mnt/cases/case001 list snapshots --no-labels
NAMESPACE       SNAPSHOTTER     CREATED AT              UPDATED AT              KIND            NAME                                                                    PARENT                                                                  LAYER PATH
k8s.io          overlayfs       2021-11-22T20:04:42Z    2021-11-22T20:04:42Z    Active          10c91402505488c2f9172143ca944b93cdf3292e6e355e54f26f5e43d0ed66ec        sha256:15449e80fe9a5f2df9e27a8969deb40f8cbb9c2a331fadad49509137978e99bb snapshots/106/fs
k8s.io          overlayfs       2021-11-22T20:04:20Z    2021-11-22T20:04:20Z    Active          143d7f19c96ca1b48c5fd8dcb66bbdee275e48627094f31107e032720acb486d        sha256:ba0dae6243cc9fa2890df40a625721fdbea5c94ca6da897acdd814d710149770 snapshots/35/fs
k8s.io          overlayfs       2021-11-22T20:04:53Z    2021-11-22T20:04:53Z    Active          1eb07ac54443b53b58672fb86bcd953af01f5958a4eafe008d52af168104cd85        sha256:95690072a2abd540fe6d43edcc989c98d0315c030b58a4599d6663d50c232b25 snapshots/123/fs
```

Listing container images

```bash
sudo container-explorer --image-root /mnt/cases/case001 list images
NAMESPACE       NAME                                                                                                                                            CREATED AT              UPDATED AT              DIGEST                                                      TYPE
k8s.io          asia.gcr.io/gke-release-staging/addon-resizer:1.8.13-gke.0                                                                                      2021-10-21T22:26:00Z    2021-10-21T22:26:06Z    sha256:feca82f3b2d1d324324c0d10d15ec43bd3bb22cf9b4f70c6ee8b24842679e493      application/vnd.docker.distribution.manifest.v2+json
k8s.io          asia.gcr.io/google-containers/pause-amd64:3.0                                                                                                   2021-10-21T22:26:33Z    2021-10-21T22:26:33Z    sha256:9f343d755727eaa271c305fb2a343292255eb0fbc68f4672582f92c648283981      application/vnd.oci.image.manifest.v1+json
k8s.io          docker.io/library/nginx:latest                                                                                                                  2021-11-22T20:05:49Z    2021-11-22T20:05:49Z    sha256:097c3a0913d7e3a5b01b6c685a60c03632fc7a2b50bc8e35bcaa3691d788226e      application/vnd.docker.distribution.manifest.list.v2+json
```

Listing contents

```bash
sudo container-explorer --image-root /mnt/cases/case001 list contents
NAMESPACE       DIGEST                                                                  SIZE            CREATED AT              UPDATED AT              LABELS
k8s.io          sha256:1e5351450a593c3a3d7a5104f93c8b80d8dc00c827158cb3a5bf985916ea3f75 25347687        2021-11-22T20:05:46Z    2021-11-22T20:05:49Z    containerd.io/uncompressed=sha256:37380c5830feb5d6829188be41a4ea0654eb5c4632f03ef093ecc182acf40e8a,containerd.io/distribution.source.docker.io=library/nginx
k8s.io          sha256:1f09ee52335c2fea46c391bed794881a030dc477134b9c7ee1ccc2ddb69ebc0b 8169            2021-11-22T20:04:46Z    2021-11-22T20:04:49Z    containerd.io/uncompressed=sha256:b4dc96b6a8939b327a3a03f3715ec416b6bea09ceaec2d5de11686f2e88be609,containerd.io/distribution.source.gke.gcr.io=event-exporter
```

**Docker managed containers**

Listing containers and exposed ports

```bash
sudo container-explorer --docker-managed --image-root /mnt/cases/case001 list containers --ports
NAMESPACE       CONTAINER ID                                                            CONTAINER HOSTNAME      IMAGE           CREATED AT              EXPOSED PORTS   NAME                    LABELS
                1114c2545b254d66668f3c964c83c3599720cc7f8c75f43c1eaf0ea7be41f341        1114c2545b25            debian:latest   2021-12-30T19:52:19Z                    recursing_chatelet
                183e02567b7527aefe07c23b3a2c633e7d46a7231e8627d94f13b513db58b8fc        183e02567b75            nginx:latest    2021-12-30T22:19:26Z    80/tcp          fervent_spence
                301e5c2b86d58d8622e6d72b34760b1c12e8077d6130c4419f0eebb9c3dd02f3        301e5c2b86d5            ubuntu:latest   2021-12-30T16:35:46Z                    sad_einstein
                44cf14183d8801ea675f1180443d408828a80ae53d087031a6168021e9c3b5e5        44cf14183d88            ubuntu:latest   2021-12-30T11:39:43Z                    ubuntu01
```

Listing container images

```bash
sudo container-explorer --docker-managed --image-root /mnt/cases/case001 list images
NAMESPACE       NAME                                                                            CREATED AT              UPDATED AT              DIGEST                                                                  TYPE
                debian:buster                                                                   2021-12-21T01:22:53Z    0001-01-01T00:00:00Z    sha256:8a94f77c4ac39c4361613cead4b0fbb1777b8b49dfce6cd19cb00a2f687d5bde
                debian:latest                                                                   2021-12-21T01:22:32Z    0001-01-01T00:00:00Z    sha256:6f4986d78878699c680b97e3d7a2fd131bf4def477f1abad9a9edcb5d99cda3c
                debian@sha256:2906804d2a64e8a13a434a1a127fe3f6a28bf7cf3696be4223b06276f32f1f2d  2021-12-21T01:22:32Z    0001-01-01T00:00:00Z    sha256:6f4986d78878699c680b97e3d7a2fd131bf4def477f1abad9a9edcb5d99cda3c
```

3; Identify the container that needs investigation. Note the container ID and namespace

Mounting a single container to a mount point

**NOTE**: `container-explorer` assumes that the mount point `/mnt/container` already exists.

```bash
sudo container-explorer -n <namespace> --image-root /mnt/cases/case001 mount <container_id> /mnt/container
sudo container-explorer --docker-managed --image-root /mnt/cases/case001 mount <container_id> /mnt/container
```

Mounting all containers to a mount point.
The `mount-all` command creates a mount point for each container based on the container ID.

```bash
sudo container-explorer --image-root /mnt/cases/case001 mount-all /mnt/container
sudo container-explorer --docker-managed --image-root /mnt/cases/case001 mount-all /mnt/container
```

**NOTE**: The `mount-all` command does not mount supporting containers created by Kubernetes. Use `--mount-support-containers` to force mounting of all supporting containers.

4; Perform analysis of the mounted container

5; Unmount the individual or all containers.

```bash
sudo umount /mnt/container
sudo umount /mnt/container/*
```

### Using `containerd` Directory

`containerd` uses `/var/lib/containerd` as the default directory. Analyst can copy
`/var/lib/containerd` and use it for analysis.

The figure shows `container-explorer` commands to analyse a copied directory.

```bash
sudo container-explorer -c test_data/var/lib/containerd list namespaces
sudo container-explorer -n default -c test_data/var/lib/containerd mount nginx-demo /tmp/mnt/case01
```

### Using bolt Databases

containerd stores information in bolt (`https://pkg.go.dev/go.etcd.io/bbolt`) database.
containerd uses the following two databases:

- `/var/lib/containerd/io.containerd.metadata.v1.bolt/meta.db`
- `/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/metadata.db`

Analyst can use the following `container-explorer` commands to explore containerd settings.

```bash
sudo container-explorer -m test_data/meta.db -s test_data/metadata.db list namespaces
```

### Using `containerd` databases

Google Kubernetes Engine (GKE) contains supporting containers. An analyst can hide the GKE support containers
using `--skip-known-containers` command line switch.

```bash
container-explorer -m test_data/gke/node/meta.db -s test_data/gke/node/metadata.db list containers --skip-known-containers

container-explorer -m test_data/gke/node2/meta.db -s test_data/gke/node2/metadata.db list containers --skip-known-containers

container-explorer -m test_data/gke/node3/meta.db -s test_data/gke/node3/metadata.db list containers --skip-known-containers

container-explorer -m test_data/gke/node4/meta.db -s test_data/gke/node4/metadata.db list containers --skip-known-containers
```

### Showing container details

List the available containers

```bash
sudo container-explorer -i /mnt/container container list
```

List the containers and show supporting kubernetes containers

```bash
sudo container-explorer -n k8s.io -m test_data/gke/node/meta.db container list --show-support-containers
```

Show container information.

```bash
sudo container-explorer -n <namespace> -i /mnt/container info container <container_id>
```

Show container spec only.

```bash
container-explorer -n <namespace> -i /mnt/container container info --spec <container_id>
```

## Running Tests

The script `run_test.sh` runs `container-explorer` tests on sample containerd data generated by using `containerd-specimens` (`https://github.com/dfirlabs/containerd-specimens`).

1; Clone `container-explorer` and `containerd-specimens`

```bash
git clone https://github.com/google/container-explorer
git clone https://github.com/dfirlabs/containerd-specimens
```

2; Change directory to `containerd-specimens`

```bash
cd containerd-specimens
```

3; Run `generate-specimens.sh` script to generate test data

```bash
sudo bash generate-specimens.sh
```

**NOTE** If the script `generate-specimens.sh` does not generate test data.
You can run `reset-containerd.sh` to uninstall and install containerd package.

**!!WARNING!!**: `reset-containerd.sh` deletes existing containers. Please use carefully.

4; Change directory to `container-explorer`

```bash
cd ../container-explorer
```

5; Run `container-explorer` test script `run_test.sh`

```bash
sudo bash run_test.sh
```
